โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  ECOSIGN ARQUITECTURA ACTUAL - RESUMEN                    โ
โ                           2026-01-05 05:22 UTC                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1๏ธโฃ  ยฟQUร ES UN "DOCUMENTO" HOY?                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   TRES MODELOS COEXISTIENDO (no consolidados):

   ๐ฆ documents (share/verify)
      โโ eco_hash: SHA-256 del .ECO
      โโ encrypted: boolean
      โโ wrapped_key: clave envuelta

   ๐ฆ user_documents (certificaciรณn)
      โโ document_hash: SHA-256 del PDF
      โโ mime_type: DEFAULT 'application/pdf' โ๏ธ
      โโ pdf_storage_path: path del PDF โ๏ธ
      โโ eco_data: certificado .ECO completo (JSONB)

   ๐ฆ eco_records (legacy)
      โโ sha256_hash: SHA-256 del archivo
      โโ file_type: MIME type โ
      โโ status: pending|anchored|verified|revoked โ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2๏ธโฃ  ยฟDรNDE SE CALCULA EL HASH?                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   ๐ LUGAR 1: hashDocument.ts
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ calculateDocumentHash(file: File)                  โ
      โ   โ                                                โ
      โ file.arrayBuffer()  โ SIN MODIFICAR โ             โ
      โ   โ                                                โ
      โ crypto.subtle.digest('SHA-256', buffer)            โ
      โ   โ                                                โ
      โ return hex                                         โ
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      Usado en: DocumentUploader, encryptedDocumentStorage

   ๐ LUGAR 2: basicCertificationWeb.ts
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ calculateSHA256(data: Uint8Array)                  โ
      โ   โ                                                โ
      โ sha256(data)  โ @noble/hashes                      โ
      โ   โ                                                โ
      โ return hex                                         โ
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      Usado en: certifyFile (generaciรณn .ECO)

   โ AMBOS calculan hash ANTES de:
      - Conversiรณn a PDF
      - Cifrado
      - Generaciรณn de .ECO
      - Cualquier transformaciรณn

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3๏ธโฃ  FLUJO "PROTEGER SIN FIRMA"                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   OPCIรN A: Con E2E Encryption (encrypt = true)
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ 1. Calculate hash del original                                  โ
   โ    hash = SHA-256(file)                                         โ
   โ                                                                  โ
   โ 2. Generate document key                                        โ
   โ    documentKey = AES-256-GCM key                                โ
   โ                                                                  โ
   โ 3. Encrypt file                                                 โ
   โ    encryptedBlob = AES-GCM(file, documentKey)                   โ
   โ                                                                  โ
   โ 4. Wrap document key                                            โ
   โ    wrappedKey = AES-GCM(documentKey, sessionUnwrapKey)          โ
   โ                                                                  โ
   โ 5. Upload to Storage                                            โ
   โ    Path: encrypted/{userId}/{hash}.enc                          โ
   โ    Content: โ Encrypted blob                                   โ
   โ                                                                  โ
   โ 6. Save to DB (documents)                                       โ
   โ    encrypted = true                                             โ
   โ    wrapped_key = base64                                         โ
   โ    hash = SHA-256 del ORIGINAL โ                               โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   OPCIรN B: Sin Encryption (encrypt = false)
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ 1. Calculate hash del original                                  โ
   โ    hash = SHA-256(file)                                         โ
   โ                                                                  โ
   โ 2. Upload to Storage                                            โ
   โ    Path: documents/{userId}/{hash}_{filename}                   โ
   โ    Content: โ๏ธ PLAINTEXT (NO cifrado)                          โ
   โ                                                                  โ
   โ 3. Save to DB (documents)                                       โ
   โ    encrypted = false                                            โ
   โ    pdf_storage_path = path                                      โ
   โ    hash = SHA-256 del original โ                               โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4๏ธโฃ  STORAGE: QUร SE GUARDA                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   Bucket: user-documents

   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ CASO 1: Proteger (E2E)                                          โ
   โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
   โ Storage:  encrypted/{userId}/{hash}.enc                         โ
   โ Content:  โ Archivo cifrado (AES-256-GCM)                      โ
   โ DB:       documents.encrypted = true                            โ
   โ           documents.wrapped_key = base64                        โ
   โ Hash:     โ Del archivo ORIGINAL (antes de cifrar)             โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ CASO 2: Proteger (sin E2E)                                      โ
   โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
   โ Storage:  documents/{userId}/{hash}_{filename}                  โ
   โ Content:  โ๏ธ Archivo SIN CIFRAR (plaintext)                    โ
   โ DB:       documents.encrypted = false                           โ
   โ Hash:     โ Del archivo original                               โ
   โ Problema: โ NO es Zero Knowledge                               โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ CASO 3: Firmar (LegalSign/SignNow)                             โ
   โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
   โ Storage:  documents/{userId}/{hash}_signed_{filename}           โ
   โ Content:  PDF con firma visual aplicada                         โ
   โ DB:       user_documents.document_hash = ...                    โ
   โ           user_documents.eco_data = {...}                       โ
   โ Hash:     โ๏ธ Del PDF FIRMADO (NO del original)                 โ
   โ Problema: โ Se pierde el hash del original                     โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ CASO 4: Compartir                                               โ
   โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
   โ Storage:  โ Nada nuevo (usa archivo existente)                โ
   โ DB:       document_shares (OTP, wrapped_key_for_share)          โ
   โ Flujo:    OTP โ unwrap key โ decrypt โ render                   โ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5๏ธโฃ  ESTADOS DEL DOCUMENTO                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   โ NO HAY FSM UNIFICADO

   Estados dispersos en mรบltiples tablas:

   ๐ฆ documents.status
      โโ active
      โโ revoked
      โโ archived

   ๐ฆ user_documents (booleanos sueltos)
      โโ has_legal_timestamp: boolean
      โโ has_bitcoin_anchor: boolean
      โโ is_archived: boolean
      โโ signnow_status: TEXT (libre)

   ๐ฆ signature_workflows.status
      โโ pending
      โโ in_progress
      โโ completed
      โโ expired
      โโ cancelled

   ๐ฆ anchors (sin campo status)
      โโ Estado se infiere de la existencia del registro

   DIAGRAMA IMPLรCITO:
   
   uploaded โ certified โ anchored โ signed โ shared โ verified
      โ          โ           โ         โ        โ         โ
   (implicit) (implicit) (implicit) (explicit)(implicit)(implicit)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 6๏ธโฃ  ESTRUCTURA DEL .ECO                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   {
     "version": "1.1.0",
     "projectId": "doc-xxxxx",
     
     "manifest": {
       "assets": [
         {
           "hash": "abc123...def",    โ โ๏ธ UN SOLO HASH
           "mimeType": "application/pdf",  โ โ Registra MIME
           "size": 102400
         }
       ]
     },
     
     "signatures": [
       {
         "publicKey": "...",
         "signature": "...",
         "algorithm": "Ed25519",
         "legalTimestamp": {
           "standard": "RFC 3161",
           "tsa": "freetsa.org",
           "token": "..."
         }
       }
     ],
     
     "metadata": {
       "anchoring": {
         "polygon": true,
         "bitcoin": true
       }
     }
   }

   โ LO QUE TIENE:
      - MIME type del original
      - Hash del archivo
      - Timestamp (local o RFC 3161)
      - Anchoring flags

   โ LO QUE FALTA:
      - parent_hash / source_hash
      - hash_chain: [original, canonical, signed]
      - transformations: [...]
      - custody: true/false
      - storage_refs: {...}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ MรTRICAS FINALES                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   Aspecto                          Actual    Target   Gap
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   Hash antes de transformar         โ 100%   โ 100%   0%
   MIME type registrado              โ 100%   โ 100%   0%
   Separaciรณn original/canรณnico      โ 0%     ๐ฏ 100%   100%
   Chain of hashes                   โ 0%     ๐ฏ 100%   100%
   Transformaciones registradas      โ 0%     ๐ฏ 100%   100%
   Custodia opcional                 โ๏ธ 50%    ๐ฏ 100%   50%
   SmartHash                         โ 0%     ๐ฏ 100%   100%
   Verificador avanzado              โ๏ธ 30%    ๐ฏ 100%   70%
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   PUNTUACIรN GLOBAL:                35/100             65%

   โ FUNDAMENTO ESTร BIEN (hash antes de transformar)
   ๐ฏ FALTA HACER EXPLรCITO LO IMPLรCITO

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ PLAN DE ACCIรN                                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   FASE 1: Separaciรณn sin romper nada (1-2 semanas)
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   - Agregar campos: original_hash, canonical_hash, transformation_log
   - Actualizar .ECO con hash_chain
   - Funciรณn registerTransformation()

   FASE 2: Custodia opcional (2-3 semanas)
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   - Modo "hash_only" (sin subir archivo)
   - Campo custody_mode: 'full' | 'hash_only'

   FASE 3: SmartHash y verificador (3-4 semanas)
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   - SmartHash = Hash(original + canonical + transformations + metadata)
   - Verificador entiende hash_chain
   - Chain of custody visual

   TIEMPO TOTAL: 6-9 semanas

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โ CONCLUSIรN                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

   Estรกs MรS CERCA de lo que pensabas.

   El hash ya se calcula ANTES de transformaciones โ
   El .ECO ya registra MIME type original โ
   E2E encryption ya existe โ

   Solo falta:
   1. Separar explicit original vs canonical (campos DB)
   2. Registrar transformations (chain of custody)
   3. Implementar SmartHash (hash compuesto)
   4. Actualizar verificador (entender chain)

   Puedes empezar YA agregando campos sin romper nada.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         FIN DEL RESUMEN VISUAL                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
