<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso Confidencial ‚Äî Paradigma LTC</title>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Fira Sans', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #f0f0f0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .container {
      max-width: 600px;
      background: rgba(20, 20, 40, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 12px;
      padding: 3rem;
      box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1);
    }
    .logo {
      text-align: center;
      font-size: 3rem;
      color: #0ff;
      margin-bottom: 1rem;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      background: linear-gradient(90deg, #0ff, #0af);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      text-align: center;
      color: #aaa;
      font-size: 0.9rem;
      margin-bottom: 2rem;
      letter-spacing: 1px;
    }
    .warning {
      background: rgba(255, 200, 0, 0.1);
      border-left: 3px solid #ffc800;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 4px;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #ccc;
      font-size: 0.9rem;
    }
    input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1.2rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      color: #fff;
      font-size: 1rem;
      transition: all 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
    }
    .nda-box {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 6px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.8;
    }
    .nda-box h3 {
      color: #0ff;
      margin-bottom: 1rem;
    }
    .nda-box p {
      margin-bottom: 1rem;
      text-align: justify;
    }
    .checkbox-container {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      cursor: pointer;
    }
    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin-right: 0.8rem;
      margin-top: 0.2rem;
      cursor: pointer;
    }
    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      flex: 1;
    }
    button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(90deg, #0ff, #0af);
      color: #000;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 255, 255, 0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .signature-pad {
      width: 100%;
      height: 150px;
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.05);
    }
    .error {
      color: #ff4444;
      font-size: 0.85rem;
      margin-top: -0.8rem;
      margin-bottom: 1rem;
    }
    .success {
      color: #44ff44;
      text-align: center;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">‚ßñ</div>
    <h1>Paradigma LTC</h1>
    <div class="subtitle">Acceso Restringido ‚Äî Documento Confidencial</div>

    <div class="warning">
      ‚ö†Ô∏è <strong>Documento Confidencial:</strong> El acceso a este contenido requiere la aceptaci√≥n de un Acuerdo de No Divulgaci√≥n (NDA). Su identidad y aceptaci√≥n ser√°n registradas con timestamp y firma digital.
    </div>

    <form id="ndaForm">
      <label for="name">Nombre Completo *</label>
      <input type="text" id="name" name="name" required placeholder="Ej: Dr. Juan P√©rez">

      <label for="email">Email *</label>
      <input type="email" id="email" name="email" required placeholder="tu@email.com">

      <label for="organization">Organizaci√≥n / Universidad *</label>
      <input type="text" id="organization" name="organization" required placeholder="Ej: Universidad de Buenos Aires">

      <label for="role">Cargo / Posici√≥n *</label>
      <input type="text" id="role" name="role" required placeholder="Ej: Investigador Principal">

      <div class="nda-box">
        <h3>Acuerdo de No Divulgaci√≥n (NDA)</h3>
        
        <p><strong>1. CONFIDENCIALIDAD</strong><br>
        El destinatario ("Receptor") acepta que toda la informaci√≥n contenida en el documento "Paradigma LTC" es estrictamente confidencial y propiedad exclusiva de Manuel S. ("Divulgante").</p>

        <p><strong>2. USO RESTRINGIDO</strong><br>
        El Receptor se compromete a:<br>
        ‚Ä¢ Usar la informaci√≥n √öNICAMENTE para evaluaci√≥n cient√≠fica y/o colaboraci√≥n acad√©mica<br>
        ‚Ä¢ NO compartir, copiar, reproducir o distribuir el contenido sin autorizaci√≥n escrita<br>
        ‚Ä¢ NO utilizar la informaci√≥n para fines comerciales sin acuerdo previo</p>

        <p><strong>3. PROPIEDAD INTELECTUAL</strong><br>
        El Receptor reconoce que:<br>
        ‚Ä¢ El paradigma LTC est√° protegido por patente en tr√°mite (Patent Pending)<br>
        ‚Ä¢ Toda la propiedad intelectual pertenece al Divulgante<br>
        ‚Ä¢ Este acceso NO otorga derechos de uso, licencia o explotaci√≥n</p>

        <p><strong>4. DURACI√ìN</strong><br>
        Este acuerdo permanece vigente durante 5 a√±os desde la fecha de aceptaci√≥n o hasta que la informaci√≥n se haga p√∫blica por el Divulgante, lo que ocurra primero.</p>

        <p><strong>5. JURISDICCI√ìN</strong><br>
        Este acuerdo se rige por las leyes del Estado de Wyoming, USA.</p>

        <p><strong>6. REGISTRO DIGITAL</strong><br>
        Al aceptar, el Receptor consiente que:<br>
        ‚Ä¢ Su identidad, timestamp y firma digital ser√°n registrados<br>
        ‚Ä¢ Esta aceptaci√≥n constituye evidencia legal vinculante<br>
        ‚Ä¢ El acceso al documento quedar√° registrado con fines de auditor√≠a</p>
      </div>

      <div class="checkbox-container">
        <input type="checkbox" id="accept" name="accept" required>
        <label for="accept">
          He le√≠do y acepto todos los t√©rminos del Acuerdo de No Divulgaci√≥n (NDA). Entiendo que esta aceptaci√≥n es legalmente vinculante y ser√° registrada con mi identidad, timestamp y firma digital.
        </label>
      </div>

      <label for="signature">Firma Digital *</label>
      <canvas id="signaturePad" class="signature-pad"></canvas>
      <button type="button" id="clearSignature" style="background: rgba(255,255,255,0.1); margin-bottom: 1rem;">
        Borrar Firma
      </button>

      <div id="error" class="error"></div>

      <button type="submit" id="submitBtn">
        ACCEDER AL DOCUMENTO
      </button>

      <div id="success" class="success"></div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="config.js"></script>
  <script>
    // Inicializar Signature Pad
    const canvas = document.getElementById('signaturePad');
    const signaturePad = new SignaturePad(canvas, {
      backgroundColor: 'rgba(255, 255, 255, 0.05)',
      penColor: '#0ff'
    });

    // Ajustar canvas al tama√±o correcto
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
      signaturePad.clear();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Bot√≥n limpiar firma
    document.getElementById('clearSignature').addEventListener('click', () => {
      signaturePad.clear();
    });

    // Funci√≥n para mostrar error
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // Funci√≥n para mostrar √©xito
    function showSuccess(message) {
      const successDiv = document.getElementById('success');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
    }

    // Funci√≥n para generar ID √∫nico
    function generateId() {
      return 'NDA-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Funci√≥n para generar hash SHA-256 del contenido del documento
    async function generateDocumentHash() {
      try {
        // Esto deber√≠a ser el hash del contenido real del documento
        // En un sistema real, obtendr√≠as el contenido de content.html
        const content = "Paradigma LTC - Metodo de composici√≥n temporal - Documento confidencial";
        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
      } catch (error) {
        console.warn('Error generando hash del documento:', error);
        // En caso de error, generar hash aleatorio como fallback
        return crypto.getRandomValues(new Uint8Array(32)).reduce((acc, val) => acc + val.toString(16).padStart(2, '0'), '');
      }
    }

    // Form submission
    document.getElementById('ndaForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const errorDiv = document.getElementById('error');
      const successDiv = document.getElementById('success');
      const submitBtn = document.getElementById('submitBtn');

      errorDiv.textContent = '';
      successDiv.textContent = '';

      // Validar firma
      if (signaturePad.isEmpty()) {
        showError('‚ö†Ô∏è Por favor, firme digitalmente en el recuadro.');
        return;
      }

      // Validar checkbox
      if (!document.getElementById('accept').checked) {
        showError('‚ö†Ô∏è Debe aceptar los t√©rminos del NDA para continuar.');
        return;
      }

      // Validaci√≥n opcional de dominio de email - comentada para permitir cualquier email
      // const userEmail = document.getElementById('email').value.toLowerCase();
      // if (!isValidEmailDomain(userEmail)) {
      //   console.log('Advertencia: El email no pertenece a una instituci√≥n acad√©mica reconocida:', userEmail);
      // }

      submitBtn.disabled = true;
      submitBtn.textContent = 'PROCESANDO...';

      try {
        // Obtener IP del cliente (con fallback)
        let clientIP = 'unknown';
        try {
          const ipResponse = await fetch('https://api.ipify.org?format=json');
          if (ipResponse.ok) {
            const ipData = await ipResponse.json();
            clientIP = ipData.ip;
          }
        } catch (ipError) {
          console.warn('Could not get IP address, using unknown');
        }

        // Generar hash del documento
        const documentHash = await generateDocumentHash();

        // Crear objeto de aceptaci√≥n
        const acceptance = {
          id: generateId(),
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          organization: document.getElementById('organization').value,
          role: document.getElementById('role').value,
          signature: signaturePad.toDataURL('image/png'),
          timestamp: new Date().toISOString(),
          ip: clientIP,
          userAgent: navigator.userAgent,
          documentHash: documentHash // Hash del documento en el momento de la firma
        };

        // Intentar registrar en backend
        let success = false;
        let accessToken = null;
        try {
          const response = await fetch('/.netlify/functions/log-acceptance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(acceptance)
          });

          if (response.ok) {
            const data = await response.json();
            if (data.accessToken) {
              acceptance.id = data.accessToken;
              accessToken = data.accessToken;
              success = true;
            } else {
              console.warn('Response did not contain access token:', data);
            }
          } else {
            console.error('API error response:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('Error details:', errorText);
          }
        } catch (apiError) {
          console.warn('API no disponible, usando fallback de localStorage:', apiError);
        }

        if (!success) {
          // Fallback: guardar en localStorage
          const existingAcceptances = JSON.parse(localStorage.getItem('ltc_nda_acceptances') || '[]');
          existingAcceptances.push(acceptance);
          localStorage.setItem('ltc_nda_acceptances', JSON.stringify(existingAcceptances));
        }

        // Guardar token de acceso
        if (success && accessToken) {
          localStorage.setItem('ltc_access_token', accessToken);
          localStorage.setItem('ltc_user_name', acceptance.name);
          localStorage.setItem('ltc_user_email', acceptance.email);
          localStorage.setItem('ltc_acceptance_date', acceptance.timestamp);
          localStorage.setItem('ltc_document_hash', acceptance.documentHash);
        } else {
          // Fallback: guardar en localStorage
          const existingAcceptances = JSON.parse(localStorage.getItem('ltc_nda_acceptances') || '[]');
          existingAcceptances.push(acceptance);
          localStorage.setItem('ltc_nda_acceptances', JSON.stringify(existingAcceptances));
          localStorage.setItem('ltc_access_token', acceptance.id);
          localStorage.setItem('ltc_user_name', acceptance.name);
          localStorage.setItem('ltc_user_email', acceptance.email);
          localStorage.setItem('ltc_acceptance_date', acceptance.timestamp);
          localStorage.setItem('ltc_document_hash', acceptance.documentHash);
        }

        // Mostrar √©xito
        showSuccess('‚úì NDA aceptado correctamente. Redirigiendo al documento...');

        // Registrar en consola para auditor√≠a
        console.log('üìã NDA Acceptance Logged:', {
          id: acceptance.id,
          name: acceptance.name,
          email: acceptance.email,
          organization: acceptance.organization,
          timestamp: acceptance.timestamp,
          ip: acceptance.ip,
          documentHash: acceptance.documentHash,
          success: success
        });

        // Redirigir al documento
        setTimeout(() => {
          if (accessToken) {
            window.location.href = `content.html?token=${encodeURIComponent(accessToken)}`;
          } else {
            window.location.href = 'content.html';
          }
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        showError('‚ùå Error al procesar la solicitud. Por favor, intente nuevamente.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üîí ACEPTAR NDA Y ACCEDER AL DOCUMENTO';
      }
    });

    // Prevenir acceso si ya est√° autenticado
    if (localStorage.getItem('ltc_access_token')) {
      if (confirm('Ya tiene una sesi√≥n activa. ¬øDesea ir directamente al documento?')) {
        window.location.href = 'content.html';
      } else {
        // Cerrar sesi√≥n
        localStorage.removeItem('ltc_access_token');
        localStorage.removeItem('ltc_user_name');
        localStorage.removeItem('ltc_user_email');
      }
    }
  </script>
</body>
</html>
